<%- include('partials/head') %>

<section class="hero">
  <div class="hero-grid">
    <!-- Left: logo, mission, actions integrated -->
    <div class="hero-left">
      <img src="/static/images/logo.png" alt="D'Leite Vegetal" class="hero-logo" onerror="this.onerror=null;this.src='/static/images/logo.jpeg'">
      <h1 class="hero-title">Compre do pequeno</h1>
      <p class="lead">
        Unimos <span class="chip-accent">produ√ß√£o local</span>, <span class="chip-accent">capacita√ß√£o</span> e
        <span class="chip-accent">distribui√ß√£o justa</span> para garantir acesso ao D'Leite Vegetal a fam√≠lias
        em situa√ß√£o de vulnerabilidade. Valorizamos os produtores da comunidade e priorizamos sa√∫de,
        dignidade e sustentabilidade ‚Äî com processos simples, transparentes e inclusivos.
      </p>
      <div class="hero-actions">
        <button class="btn primary" onclick="openQRScanner()">LER QR CODE DA EMBALAGEM</button>
        <a class="btn" href="/login">i9 / Associa√ß√£o Login</a>
      </div>
    </div>
    <!-- Right: bottle with animation -->
    <div class="hero-bottle">
      <img src="/static/images/bottle.png" alt="Garrafa de D'Leite Vegetal">
    </div>
  </div>
</section>

<section class="impact-section">
  <h2 class="impact-title">Nosso Impacto</h2>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" data-count="1000">0</div>
      <div class="stat-label">Fam√≠lias Atendidas</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" data-count="500">0</div>
      <div class="stat-label">Litros Produzidos</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" data-count="50">0</div>
      <div class="stat-label">Produtores Locais</div>
    </div>
  </div>
</section>

<section class="media-showcase">
  <div class="showcase-grid">
    <!-- Video -->
    <div class="media-frame">
      <video src="/static/images/video.mp4" autoplay muted loop playsinline preload="metadata" poster="/static/images/picture1.jpeg"></video>
    </div>
    <!-- Carousel -->
    <div class="carousel">
      <div class="slides">
        <div class="slide"><img src="/static/images/picture2.jpeg" alt="D'Leite Vegetal 2" /></div>
        <div class="slide"><img src="/static/images/picture3.jpeg" alt="D'Leite Vegetal 3" /></div>
        <div class="slide"><img src="/static/images/picture4.jpeg" alt="D'Leite Vegetal 4" /></div>
        <div class="slide"><img src="/static/images/picture5.jpeg" alt="D'Leite Vegetal 5" /></div>
        <div class="slide"><img src="/static/images/picture6.jpeg" alt="D'Leite Vegetal 6" /></div>
      </div>
      <div class="nav">
        <button data-prev aria-label="Previous">‚Üê</button>
        <button data-next aria-label="Next">‚Üí</button>
      </div>
      <div class="dots"></div>
    </div>
  </div>
</section>

<section class="cta-section">
  <div class="cta-content">
    <h2 class="cta-title">Fa√ßa Parte da Transforma√ß√£o</h2>
    <p class="cta-text">Juntos, constru√≠mos uma comunidade mais saud√°vel, justa e sustent√°vel.</p>
    <div class="cta-buttons">
      <button class="btn primary big" onclick="openQRScanner()">Escanear QR Code</button>
      <a class="btn secondary big" href="/login">Fazer Login</a>
    </div>
  </div>
</section>

<footer class="landing-footer">
  <div class="footer-content">
    <p class="footer-brand">Propriedade de i9</p>
    <p class="footer-tagline">Compre do pequeno</p>
    <div class="footer-social">
      <span class="social-icon">üå±</span>
      <span class="social-icon">üíö</span>
      <span class="social-icon">ü§ù</span>
    </div>
  </div>
</footer>

<!-- QR Scanner Modal -->
<div id="qr-modal" class="qr-modal">
  <div class="qr-modal-content">
    <button class="qr-modal-close" onclick="closeQRScanner()">&times;</button>
    <h2 class="qr-modal-title">Escanear QR Code</h2>
    <p class="qr-modal-subtitle">Aponte a c√¢mera para o c√≥digo QR da embalagem</p>
    <div class="qr-scanner-container">
      <video id="qr-video" autoplay playsinline></video>
      <canvas id="qr-canvas" style="display:none"></canvas>
      <div id="qr-status" class="qr-status">Inicializando c√¢mera...</div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let qrStream = null;
let qrAnimationId = null;

function openQRScanner() {
  const modal = document.getElementById('qr-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  startQRCamera();
}

function closeQRScanner() {
  const modal = document.getElementById('qr-modal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  stopQRCamera();
}

function stopQRCamera() {
  if (qrStream) {
    qrStream.getTracks().forEach(track => track.stop());
    qrStream = null;
  }
  if (qrAnimationId) {
    cancelAnimationFrame(qrAnimationId);
    qrAnimationId = null;
  }
}

async function startQRCamera() {
  const video = document.getElementById('qr-video');
  const canvas = document.getElementById('qr-canvas');
  const ctx = canvas.getContext('2d');
  const status = document.getElementById('qr-status');

  try {
    qrStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    video.srcObject = qrStream;
    status.textContent = 'C√¢mera pronta. Aponte para o c√≥digo QR.';

    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);

        if (code && code.data) {
          status.textContent = 'QR detectado! Redirecionando...';
          const data = code.data.trim();
          stopQRCamera();

          try {
            const url = new URL(data, window.location.origin);
            if (url.pathname.startsWith('/scan/')) {
              window.location.href = url.href;
            } else {
              window.location.href = '/scan/' + encodeURIComponent(data);
            }
          } catch {
            window.location.href = '/scan/' + encodeURIComponent(data);
          }
          return;
        }
      }
      qrAnimationId = requestAnimationFrame(tick);
    }

    qrAnimationId = requestAnimationFrame(tick);
  } catch (e) {
    status.textContent = 'N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.';
    console.error('Camera error:', e);
  }
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
  const modal = document.getElementById('qr-modal');
  if (e.target === modal) {
    closeQRScanner();
  }
});
</script>

<%- include('partials/foot') %>
