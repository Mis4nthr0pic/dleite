<%- include('partials/head') %>

<section class="hero">
  <div class="hero-grid">
    <!-- Left: logo, mission, actions integrated -->
    <div class="hero-left">
      <a href="/" aria-label="P√°gina inicial"><img src="/static/images/logo.png" alt="D'Leite Vegetal" class="hero-logo" onerror="this.onerror=null;this.src='/static/images/logo.jpeg'"></a>
      <h1 class="hero-title"><%= t('home.title', { defaultValue: 'Da Comunidade para a Comunidade' }) %></h1>
      <p class="lead">
        <%= t('home.subtitle', { defaultValue: 'Unimos produ√ß√£o local, capacita√ß√£o e distribui√ß√£o justa para garantir acesso ao D‚ÄôLeite Vegetal com processos simples, transparentes e inclusivos.' }) %>
      </p>
      <div class="hero-actions">
        <button class="btn primary" onclick="openQRScanner()"><%= t('home.ctaScan', { defaultValue: 'LER QR CODE DA EMBALAGEM' }) %></button>
        <a class="btn" href="/login"><%= t('home.ctaLogin', { defaultValue: 'i9 / Associa√ß√£o Login' }) %></a>
      </div>
    </div>
    <!-- Right: bottle with animation -->
    <div class="hero-bottle">
      <img src="/static/images/bottle.png" alt="Garrafa de D'Leite Vegetal">
    </div>
  </div>
</section>

<section class="impact-section">
  <h2 class="impact-title"><%= t('impact.title', { defaultValue: 'Nosso Impacto' }) %></h2>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number">2.450</div>
      <div class="stat-label"><%= t('impact.liters', { defaultValue: 'Litros' }) %></div>
    </div>
    <div class="stat-card">
      <div class="stat-number">200</div>
      <div class="stat-label"><%= t('impact.families', { defaultValue: 'Fam√≠lias' }) %></div>
    </div>
    <div class="stat-card">
      <div class="stat-number">7</div>
      <div class="stat-label"><%= t('impact.yearsStudy', { defaultValue: 'Anos de estudo' }) %></div>
    </div>
    <div class="stat-card">
      <div class="stat-number">2</div>
      <div class="stat-label"><%= t('impact.yearsDelivery', { defaultValue: 'Anos de entrega' }) %></div>
    </div>
  </div>
</section>

<section class="media-showcase">
  <div class="showcase-grid">
    <!-- Video -->
    <div class="media-frame">
      <video src="/static/images/video.mp4" autoplay muted loop playsinline preload="metadata" poster="/static/images/picture1.jpeg"></video>
    </div>
    <!-- Carousel -->
    <div class="carousel">
      <div class="slides">
        <div class="slide"><img src="/static/images/picture2.jpeg" alt="D'Leite Vegetal 2" /></div>
        <div class="slide"><img src="/static/images/picture3.jpeg" alt="D'Leite Vegetal 3" /></div>
        <div class="slide"><img src="/static/images/picture4.jpeg" alt="D'Leite Vegetal 4" /></div>
        <div class="slide"><img src="/static/images/picture5.jpeg" alt="D'Leite Vegetal 5" /></div>
        <div class="slide"><img src="/static/images/picture6.jpeg" alt="D'Leite Vegetal 6" /></div>
      </div>
      <div class="nav">
        <button data-prev aria-label="Previous">‚Üê</button>
        <button data-next aria-label="Next">‚Üí</button>
      </div>
      <div class="dots"></div>
    </div>
  </div>
</section>

<section class="cta-section">
  <div class="cta-content">
    <h2 class="cta-title">Fa√ßa Parte da Transforma√ß√£o</h2>
    <p class="cta-text">Juntos, constru√≠mos uma comunidade mais saud√°vel, justa e sustent√°vel.</p>
    <div class="cta-buttons">
      <button class="btn primary big" onclick="openQRScanner()">Escanear QR Code</button>
      <a class="btn secondary big" href="/login">Fazer Login</a>
    </div>
  </div>
</section>

<footer class="landing-footer">
  <div class="footer-content">
    <p class="footer-brand">Propriedade de i9</p>
    <p class="footer-tagline">Compre do pequeno</p>
    <div class="footer-social">
      <span class="social-icon">üå±</span>
      <span class="social-icon">üíö</span>
      <span class="social-icon">ü§ù</span>
    </div>
  </div>
</footer>

<!-- QR Scanner Modal -->
<div id="qr-modal" class="qr-modal">
  <div class="qr-modal-content">
    <button class="qr-modal-close" onclick="closeQRScanner()">&times;</button>
    <h2 class="qr-modal-title"><%= t('qr.modalTitle', { defaultValue: 'Escanear QR Code' }) %></h2>
    <p class="qr-modal-subtitle"><%= t('qr.modalSubtitle', { defaultValue: 'Aponte a c√¢mera para o c√≥digo QR da embalagem' }) %></p>
    <div class="qr-scanner-container">
      <video id="qr-video" autoplay playsinline></video>
      <canvas id="qr-canvas" style="display:none"></canvas>
      <div id="qr-status" class="qr-status"><%= t('qr.initializing', { defaultValue: 'Inicializando c√¢mera...' }) %></div>
    </div>
    <div id="qr-result" class="qr-result" style="display:none;margin-top:14px">
      <h3 style="margin:0 0 8px"><%= t('qr.resultTitle', { defaultValue: 'Resultado da Leitura' }) %></h3>
      <div class="qr-result-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">
        <div><strong><%= t('common.batch') %>:</strong> <span id="qr-res-batch">-</span></div>
        <div><strong><%= t('common.producer') %>:</strong> <span id="qr-res-producer">-</span></div>
        <div><strong><%= t('common.expiry') %>:</strong> <span id="qr-res-expiry">-</span></div>
        <div><strong>Associa√ß√£o:</strong> <span id="qr-res-assoc">-</span></div>
        <div style="grid-column:span 2"><strong>Token:</strong> <span id="qr-res-token">-</span></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
let qrStream = null;
let qrAnimationId = null;

function openQRScanner() {
  const modal = document.getElementById('qr-modal');
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  startQRCamera();
}

function closeQRScanner() {
  const modal = document.getElementById('qr-modal');
  modal.style.display = 'none';
  document.body.style.overflow = '';
  stopQRCamera();
}

function stopQRCamera() {
  if (qrStream) {
    qrStream.getTracks().forEach(track => track.stop());
    qrStream = null;
  }
  if (qrAnimationId) {
    cancelAnimationFrame(qrAnimationId);
    qrAnimationId = null;
  }
}

async function startQRCamera() {
  const video = document.getElementById('qr-video');
  const canvas = document.getElementById('qr-canvas');
  const ctx = canvas.getContext('2d');
  const status = document.getElementById('qr-status');

  try {
    qrStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment' }
    });
    video.srcObject = qrStream;
    status.textContent = 'C√¢mera pronta. Aponte para o c√≥digo QR.';

    async function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);

        if (code && code.data) {
          status.textContent = 'QR detectado! Consultando...';
          const raw = code.data.trim();
          const token = raw.replace(/^.*\/scan\//,'');
          try {
            const resp = await fetch('/scan/api/' + encodeURIComponent(token));
            if (!resp.ok) throw new Error('request failed');
            const json = await resp.json();
            if (json && json.success && json.info) {
              document.getElementById('qr-res-batch').textContent = json.info.batch_number || '-';
              document.getElementById('qr-res-producer').textContent = json.info.producer_name || '-';
              document.getElementById('qr-res-expiry').textContent = json.info.expiry_date || '-';
              document.getElementById('qr-res-assoc').textContent = json.info.association_name || '-';
              document.getElementById('qr-res-token').textContent = json.info.token || '-';
              document.getElementById('qr-result').style.display = 'block';
              status.textContent = json.status === 'ok' ? 'Consumo registrado.' : 'QR j√° consumido.';
              stopQRCamera();
              return;
            } else {
              status.textContent = 'QR inv√°lido.';
            }
          } catch (err) {
            console.error(err);
            status.textContent = 'Erro ao consultar QR.';
          }
        }
      }
      qrAnimationId = requestAnimationFrame(tick);
    }

    qrAnimationId = requestAnimationFrame(tick);
  } catch (e) {
    status.textContent = 'N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.';
    console.error('Camera error:', e);
  }
}

// Close modal when clicking outside
document.addEventListener('click', (e) => {
  const modal = document.getElementById('qr-modal');
  if (e.target === modal) {
    closeQRScanner();
  }
});
</script>

<%- include('partials/foot') %>
